<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ACA Registration form</title>
		<style>
			body {
			background-color: #f5f5f5;
			text-align: center;
			}
			.banner {
			width: 100%;
			min-width: 817px;
			padding-top: 20px;
			margin-left: auto;
			margin-right: auto;
			position: relative;
			z-index: 2;
			height: 200px;
			}
			.banner h2 {
			font-family: Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif;
			margin-top: 10px;
			margin-bottom: 0px;
			padding-bottom: .8em;
			padding-left: 10px;
			padding-right: 10px;
			font-size: 2.6em;
			}
			
			iframe {
			background-color: #f5f5f5;
			width: 817px;
			border: none;
			position: relative;
			z-index: 1;
			margin-top: -80px;
			margin-left: auto;
			margin-right:auto;
			overflow: hidden;
			height: 780px;
			}
			
			#evt_description {
			width: 801px;
			min-width: 801px;
			background-color: white;
			margin-left: auto;
			margin-right: auto;
			display: none;
			margin-bottom: 50px;
			font-size: .9em;
			padding: 10px;
			position:relative;
			z-index:2;
			text-align: left;
			}

			#header{
			width: 100%;
			top: 0px;
			left: 0px;
			position: absolute;
			}

			#logo {
			height: 70px;
			}
		</style>
		<script src="https://unpkg.com/showdown/dist/showdown.min.js"></script>
	</head>
	<body onload="init()">
	<div id="header">
		<div class="banner">
		<img id="logo" src="logo_aca.png" alt="ACA Logo"><br>
		<h2 id="bannerTitle">ACA Event Sign-up Form</h2>
		</div>
		<div id="evt_description"></div>
		<iframe title="Sign-up form"></iframe>
	</div>
	<script>
		const firstFormURL = 'https://cloud.seatable.io/dtable/forms/7ded1d43-de88-407d-aef6-904abe512cef/';
		const webhookURL = 'https://hook.eu2.make.com/g5onnawfymkb1tedu10g44y9ffwpn6gh';
		var converter = new showdown.Converter();
		let evtID,
			queryID,
			evtName ,
			registrationURL,
			contactInfos,
			evtPresentation = "";
		function init() {
			let iframe = document.querySelector('iframe');
			iframe.style.display='none';
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			if (urlParams.has('s')) {
				step = Number(urlParams.get('s'));
			}
			if (urlParams.has('t')) {
				evtName = urlParams.get('t');
				document.getElementById('bannerTitle').innerHTML = evtName;
			}
			if (urlParams.has('bg')) {
				document.getElementsByClassName('banner')[0].style.backgroundColor = "#" + urlParams.get('bg');
			}
			if (urlParams.has('col')) {
				document.getElementById('bannerTitle').style.color = "#" + urlParams.get('col');
			}
			if (urlParams.has('e')) {
				evtID = urlParams.get('e');
			}
			if (urlParams.has('q')) {
				queryID = urlParams.get('q');
			}
			if (step==1 && evtID != "") {
				iframe.src = firstFormURL + '?prefillHide_evtName=' + evtName + '&prefillHide_evtshortID=' + evtID;
				iframe.style.display='block';
			} else if (step==2 && queryID != "") {
				let cpt = 0;
				console.log("send request");
				let data = new FormData();
				data.append('action','reg_on');
				data.append('queryID',queryID);
				fetch(webhookURL, {
				method: "POST",
				body: data
				}).then(function(response) {
				return response.json();
				}).then(function(data) {
					console.log(data);
					registrationURL = data.registrationURL;
					evtPresentation = converter.makeHtml(data.evtPresentation);
					console.log(registrationURL);
					contactInfos = data["Contact Infos"];
					if (contactInfos) {
						iframe.src = contactInfos;
						iframe.addEventListener('load', () => {
							cpt += 1;
							if (cpt == 2) { 
								if (evtPresentation != "") {
									document.getElementById('evt_description').innerHTML = evtPresentation;
									document.getElementById('evt_description').style.display="block";
								}
								document.querySelector('iframe').src = registrationURL ;
								document.querySelector('iframe').style.marginTop = '-130px';
								// eventually resize the iframe depending on your form's height 
								// (unfortunately you can't get directly the height so you have to hardcode this value)
								document.querySelector('iframe').style.height = '1000px'; // careful, depending on the number of questions !!
							}
						});
						iframe.style.height = '2450px';
						iframe.style.display='block';
						//document.querySelector('iframe').style.height = '2450px';
					}
				});
			}
		}
	</script>
	</body>
</html>
