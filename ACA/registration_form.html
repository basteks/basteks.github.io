<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ACA Registration form</title>
		<link rel="stylesheet" type="text/css" href="jsuites.loading.css" />
		<link rel="stylesheet" type="text/css" href="jsuites.modal.css" />
		<link rel="stylesheet" type="text/css" href="formstyle.css" />
		<script src="https://unpkg.com/showdown/dist/showdown.min.js"></script>
	</head>
	<body onload="init()">
	<div id="header">
		<div class="banner">
		<img id="logo" src="logo_aca.png" alt="ACA Logo"><br>
		<h2 id="bannerTitle">ACA Event Sign-up Form</h2>
		</div>
		<div id="evt_description"></div>
		<div id="loader"></div>
		<iframe title="Sign-up form"></iframe>
	</div>
	<script src="jsuites.loading-modal.js"></script>
	<script>
		const firstFormURL = 'https://cloud.seatable.io/dtable/forms/7ded1d43-de88-407d-aef6-904abe512cef/';
		const webhookURL = 'https://hook.eu2.make.com/g5onnawfymkb1tedu10g44y9ffwpn6gh';
		var converter = new showdown.Converter();
		jSuites.loading.show();
		let evtID,
			queryID,
			evtName ,
			registrationURL,
			contactInfos,
			evtPresentation = "";
		function init() {
			let iframe = document.querySelector('iframe');
			iframe.style.display='none';
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			if (urlParams.has('s')) {
				step = Number(urlParams.get('s'));
			}
			if (urlParams.has('t')) {
				evtName = urlParams.get('t');
				document.getElementById('bannerTitle').innerHTML = evtName;
			}
			if (urlParams.has('bg')) {
				document.getElementsByClassName('banner')[0].style.backgroundColor = "#" + urlParams.get('bg');
			}
			if (urlParams.has('col')) {
				document.getElementById('bannerTitle').style.color = "#" + urlParams.get('col');
			}
			if (urlParams.has('e')) {
				evtID = urlParams.get('e');
			}
			if (urlParams.has('q')) {
				queryID = urlParams.get('q');
			}
			if (step==1 && evtID != "") {
				iframe.src = firstFormURL + '?prefillHide_evtName=' + evtName + '&prefillHide_evtshortID=' + evtID;
				iframe.style.display='block';
				jSuites.loading.hide();
			} else if (step==2 && queryID != "") {
				let cpt = 0;
				console.log("send request");
				let data = new FormData();
				data.append('action','reg_on');
				data.append('queryID',queryID);
				fetch(webhookURL, {
				method: "POST",
				body: data
				}).then(function(response) {
				return response.json();
				}).then(function(data) {
					registrationURL = data.registrationURL;
					evtPresentation = converter.makeHtml(data.evtPresentation);
					console.log(registrationURL);
					contactInfos = data["Contact Infos"];
					if (contactInfos) {
						iframe.src = contactInfos;
						iframe.addEventListener('load', () => {
							cpt += 1;
							if (cpt == 2) { 
								if (evtPresentation != "") {
									document.getElementById('evt_description').innerHTML = evtPresentation;
									document.getElementById('evt_description').style.display="block";
								}
								document.querySelector('iframe').src = registrationURL ;
								document.querySelector('iframe').style.marginTop = '-130px';
								// eventually resize the iframe depending on your form's height 
								// (unfortunately you can't get directly the height so you have to hardcode this value)
								document.querySelector('iframe').style.height = '1000px'; // careful, depending on the number of questions !!
								jSuites.loading.hide();
							}
						});
						iframe.style.height = '3000px';
						iframe.style.display='block';
						jSuites.loading.hide();
						//document.querySelector('iframe').style.height = '2450px';
					}
				});
			}
		}
	</script>
	</body>
</html>
